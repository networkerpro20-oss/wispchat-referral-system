generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Cliente referidor - Auto-registro desde WispChat
model Client {
  id                String          @id @default(cuid())
  
  // Datos del cliente en WispChat (sincronizados en auto-registro)
  wispChatClientId  String          @unique // ID del cliente en WispChat (ej: 8, 53, 55)
  wispChatUserId    String?         // ID del usuario en WispChat (si tiene cuenta)
  nombre            String
  email             String          @unique
  telefono          String?
  
  // Código único de referido
  referralCode      String          @unique // Código para compartir (ej: EASY-12345)
  shareUrl          String          @unique // URL completa: /easyaccess/EASY-12345
  
  // Estado de pagos (actualizado desde CSV)
  lastInvoiceStatus InvoiceStatus?  // Estado de su última factura (PAID/PENDING)
  lastInvoiceDate   DateTime?       // Fecha de su última factura procesada
  isPaymentCurrent  Boolean         @default(true) // ¿Está al día con sus pagos?
  
  // Estadísticas
  totalReferrals    Int             @default(0)
  totalEarned       Decimal         @db.Decimal(10,2) @default(0) // Total ganado
  totalActive       Decimal         @db.Decimal(10,2) @default(0) // Total activo (puede cobrar)
  totalApplied      Decimal         @db.Decimal(10,2) @default(0) // Total ya cobrado
  
  // Referidos que ha generado
  referrals         Referral[]
  
  // Comisiones ganadas
  commissions       Commission[]
  
  // Metadata
  active            Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([wispChatClientId])
  @@index([email])
  @@index([referralCode])
  @@index([isPaymentCurrent])
}

// Lead/Referido - persona que llegó por link
model Referral {
  id                String          @id @default(cuid())
  
  // Cliente que lo refirió
  clientId          String
  client            Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Datos del lead (del formulario)
  nombre            String
  telefono          String          // WhatsApp principal
  email             String?
  direccion         String?
  colonia           String?
  ciudad            String?
  codigoPostal      String?
  tipoServicio      String?         // fibra/radio
  velocidad         String?         // 20M/50M/100M
  
  // Estado del proceso
  status            ReferralStatus  @default(PENDING)
  
  // Instalación (cuando se convierte en cliente de WispChat)
  fechaContacto     DateTime?       // Cuándo se contactó
  fechaInstalacion  DateTime?       // Cuándo se instaló
  wispChatClientId  String?         // ID en WispChat cuando se convierte en cliente (ej: 77, 84, 96)
  
  // Estado de pagos del referido (actualizado desde CSV)
  lastInvoiceStatus InvoiceStatus?  // Estado de su última factura
  lastInvoiceDate   DateTime?       // Fecha de su última factura procesada
  
  // Comisiones generadas
  commissions       Commission[]
  
  // Notas internas
  notas             String?         @db.Text
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([clientId])
  @@index([status])
  @@index([email])
  @@index([telefono])
  @@index([wispChatClientId])
}

enum ReferralStatus {
  PENDING           // Lead registrado, pendiente de contactar
  CONTACTED         // Contactado por admin
  INSTALLED         // Ya instalado (es cliente en WispChat)
  REJECTED          // Sin cobertura o rechazado
}

// Comisión ganada por referido
model Commission {
  id                String           @id @default(cuid())
  
  // A quién se le paga (cliente referidor)
  clientId          String
  client            Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Por qué referido
  referralId        String
  referral          Referral         @relation(fields: [referralId], references: [id], onDelete: Cascade)
  
  // Tipo y monto
  type              CommissionType
  amount            Decimal          @db.Decimal(10,2)
  
  // Para comisiones mensuales (mes 1-6)
  monthNumber       Int?
  monthDate         DateTime?        // Fecha de la factura pagada del referido
  
  // Estado mejorado
  status            CommissionStatus @default(EARNED)
  
  // Razón si está en espera o cancelada
  statusReason      String?          // Ej: "Cliente referidor no está al día", "Referido canceló servicio"
  
  // Aplicación a factura
  applications      CommissionApplication[]
  
  // Notas
  notas             String?          @db.Text
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([clientId])
  @@index([referralId])
  @@index([status])
  @@index([type])
}

enum CommissionType {
  INSTALLATION      // $500 por instalación
  MONTHLY           // $50 por mes (1-6)
}

enum CommissionStatus {
  EARNED            // Ganada (referido pagó) pero cliente referidor NO está al día
  ACTIVE            // Activa (referido pagó Y cliente está al día) - PUEDE COBRAR
  APPLIED           // Aplicada total o parcialmente a factura
  CANCELLED         // Cancelada (referido canceló servicio)
}

// Registro de aplicación de comisión a factura
model CommissionApplication {
  id                String           @id @default(cuid())
  
  // Qué comisión se aplicó
  commissionId      String
  commission        Commission       @relation(fields: [commissionId], references: [id], onDelete: Cascade)
  
  // Detalles de la aplicación
  amount            Decimal          @db.Decimal(10,2) // Cuánto se descontó
  
  // Factura de WispChat donde se aplicó
  wispChatInvoiceId String          // ID de la factura en WispChat
  invoiceMonth      String          // Ej: "Enero 2025"
  invoiceAmount     Decimal         @db.Decimal(10,2) // Total de la factura
  
  // Quién lo aplicó
  appliedBy         String          // Nombre del admin
  appliedAt         DateTime        @default(now())
  
  // Notas
  notas             String?         @db.Text
  
  @@index([commissionId])
  @@index([wispChatInvoiceId])
}

// Carga de CSV de facturas (día 7 y 21)
model InvoiceUpload {
  id                String           @id @default(cuid())
  
  // Archivo CSV
  fileName          String
  filePath          String          // Ruta en servidor
  fileUrl           String?         // URL para descargar
  
  // Período
  uploadDate        DateTime        @default(now())
  periodStart       DateTime        // Inicio del período (últimos 20 días)
  periodEnd         DateTime        // Fin del período
  
  // Estadísticas
  totalInvoices     Int             @default(0) // Total de facturas en CSV
  paidInvoices      Int             @default(0) // Facturas pagadas
  pendingInvoices   Int             @default(0) // Facturas pendientes
  
  // Procesamiento
  processed         Boolean         @default(false)
  processedAt       DateTime?
  commissionsGenerated Int          @default(0) // Comisiones mensuales generadas
  commissionsActivated Int          @default(0) // Comisiones activadas (cliente al día)
  
  // Datos parseados del CSV
  invoices          InvoiceRecord[]
  
  // Quién lo subió
  uploadedBy        String          // Admin que subió el archivo
  
  // Notas
  notas             String?         @db.Text
  
  createdAt         DateTime        @default(now())
  
  @@index([uploadDate])
  @@index([processed])
}

// Registro individual de factura del CSV
model InvoiceRecord {
  id                String           @id @default(cuid())
  
  // Upload al que pertenece
  uploadId          String
  upload            InvoiceUpload    @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  
  // Datos de la factura (del CSV Easy Access)
  wispChatClientId  String          // ID del cliente en WispChat (8, 53, 55, etc.)
  wispChatInvoiceId String          // Número de factura (#Factura)
  clientName        String
  invoiceDate       DateTime
  dueDate           DateTime
  amount            Decimal         @db.Decimal(10,2)
  status            InvoiceStatus   // PAID o PENDING
  
  // Clasificación
  isReferrer        Boolean         @default(false) // ¿Es un cliente referidor?
  isReferral        Boolean         @default(false) // ¿Es un referido instalado?
  
  // Referido asociado (si existe)
  matchedReferralId String?
  
  createdAt         DateTime        @default(now())
  
  @@index([uploadId])
  @@index([wispChatClientId])
  @@index([wispChatInvoiceId])
  @@index([status])
  @@index([matchedReferralId])
  @@index([isReferrer])
  @@index([isReferral])
}

enum InvoiceStatus {
  PAID              // Factura pagada
  PENDING           // Factura pendiente
}

// Configuración global del sistema
model Settings {
  id                    String   @id @default(cuid())
  
  // Montos de comisiones
  installationAmount    Decimal  @db.Decimal(10,2) @default(500.00)
  monthlyAmount         Decimal  @db.Decimal(10,2) @default(50.00)
  monthsToEarn          Int      @default(6)
  
  // WispChat API
  wispChatUrl           String   @default("https://wispchat-backend.onrender.com")
  wispChatTenantDomain  String   @default("easyaccessnet.com")
  
  // Credenciales de admin para WispChat API
  wispChatAdminEmail    String?
  wispChatAdminPassword String?
  
  // Email notifications
  notificationEmail     String?
  
  updatedAt             DateTime @updatedAt
}
