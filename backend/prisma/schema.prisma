generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Cliente referidor - sincronizado desde WispHub
model Client {
  id                String          @id @default(cuid())
  
  // Datos del cliente en WispHub (solo consulta)
  wispHubClientId   String          @unique // Número de cliente en WispHub
  nombre            String
  email             String
  telefono          String?
  
  // Código único de referido
  referralCode      String          @unique // Código para compartir (ej: EASY-12345)
  shareUrl          String          @unique // URL completa: /easyaccess/EASY-12345
  
  // Estadísticas
  totalReferrals    Int             @default(0)
  totalEarned       Decimal         @db.Decimal(10,2) @default(0)
  totalApplied      Decimal         @db.Decimal(10,2) @default(0)
  
  // Referidos que ha generado
  referrals         Referral[]
  
  // Comisiones ganadas
  commissions       Commission[]
  
  // Metadata
  active            Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([wispHubClientId])
  @@index([referralCode])
}

// Lead/Referido - persona que llegó por link
model Referral {
  id                String          @id @default(cuid())
  
  // Cliente que lo refirió
  clientId          String
  client            Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Datos del lead (del formulario)
  nombre            String
  telefono          String          // WhatsApp principal
  email             String?
  direccion         String?
  colonia           String?
  ciudad            String?
  codigoPostal      String?
  tipoServicio      String?         // fibra/radio
  velocidad         String?         // 20M/50M/100M
  
  // Estado del proceso
  status            ReferralStatus  @default(PENDING)
  
  // Instalación
  fechaContacto     DateTime?       // Cuándo se contactó
  fechaInstalacion  DateTime?       // Cuándo se instaló
  wispHubClientId   String?         // ID cuando se convierte en cliente
  
  // Comisiones generadas
  commissions       Commission[]
  
  // Notas internas
  notas             String?         @db.Text
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([clientId])
  @@index([status])
  @@index([wispHubClientId])
}

enum ReferralStatus {
  PENDING           // Lead registrado, pendiente de contactar
  CONTACTED         // Contactado por admin
  INSTALLED         // Ya instalado (es cliente en WispHub)
  REJECTED          // Sin cobertura o rechazado
}

// Comisión ganada por referido
model Commission {
  id                String           @id @default(cuid())
  
  // A quién se le paga (cliente referidor)
  clientId          String
  client            Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Por qué referido
  referralId        String
  referral          Referral         @relation(fields: [referralId], references: [id], onDelete: Cascade)
  
  // Tipo y monto
  type              CommissionType
  amount            Decimal          @db.Decimal(10,2)
  
  // Para comisiones mensuales (mes 1-6)
  monthNumber       Int?
  monthDate         DateTime?        // Qué mes se pagó en WispHub
  
  // Estado
  status            CommissionStatus @default(EARNED)
  
  // Aplicación a factura
  applications      CommissionApplication[]
  
  // Notas
  notas             String?          @db.Text
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([clientId])
  @@index([referralId])
  @@index([status])
  @@index([type])
}

enum CommissionType {
  INSTALLATION      // $500 por instalación
  MONTHLY           // $50 por mes (1-6)
}

enum CommissionStatus {
  EARNED            // Ganada pero no aplicada
  APPLIED           // Aplicada total o parcialmente
  CANCELLED         // Cancelada (cliente referido canceló servicio)
}

// Registro de aplicación de comisión a factura
model CommissionApplication {
  id                String           @id @default(cuid())
  
  // Qué comisión se aplicó
  commissionId      String
  commission        Commission       @relation(fields: [commissionId], references: [id], onDelete: Cascade)
  
  // Detalles de la aplicación
  amount            Decimal          @db.Decimal(10,2) // Cuánto se descontó
  
  // Factura de WispHub donde se aplicó
  wispHubInvoiceId  String          // ID de la factura en WispHub
  invoiceMonth      String          // Ej: "Enero 2025"
  invoiceAmount     Decimal         @db.Decimal(10,2) // Total de la factura
  
  // Quién lo aplicó
  appliedBy         String          // Nombre del admin
  appliedAt         DateTime        @default(now())
  
  // Notas
  notas             String?         @db.Text
  
  @@index([commissionId])
}

// Configuración global del sistema
model Settings {
  id                    String   @id @default(cuid())
  
  // Montos de comisiones
  installationAmount    Decimal  @db.Decimal(10,2) @default(500.00)
  monthlyAmount         Decimal  @db.Decimal(10,2) @default(50.00)
  monthsToEarn          Int      @default(6)
  
  // WispHub API
  wispHubUrl            String?
  wispHubApiKey         String?
  
  // Email notifications
  notificationEmail     String?
  
  updatedAt             DateTime @updatedAt
}
